\chapter{Thrust 0: \Cyclus Infrastructure Development}\label{chap:thrust0}

Under Thrust 0, the \Cyclus framework was advanced from a conceptual design to
a fully functional software tool.  As this project began, the fundamental
features of \Cyclus were in place, but it was far from a usable tool for fuel
cycle simulation.  Through the efforts of this project, \Cyclus emerged as a
more usable and stable software platform for nuclear fuel cycle analysis.  The
overarching goal was to provide maximum flexibility so that changes in fuel
cycle design did not require substantial retooling of the software.  Specific
design features that support this flexibility include:
\begin{enumerate}
\item \textbf{Modular design} to support extensibility with runtime swappable facility models.
\item \textbf{Agent-based approach} to incorporate social/behavior interaction models to govern how each facility interacts with others.
\item \textbf{Individual facility modeling} to allow each facility to operate in a distinct manner, allowing modeling of startup, shutdown and other disruptions.
\item \textbf{Discrete material tracking at the nuclide level} to capture the effects of individual facility performance and enable forensic tracking of material object ownership.
\item \textbf{Minimal physics assumptions} to enable different users to invoke low fidelity, systems level models or high fidelity, facility level models, or anything in between.
\end{enumerate}

Under this project, the \Cyclus effort developed into an \textit{ecosystem} composed of:
\begin{itemize}
\item an open source simulation kernel, known as \Cyclus,
\item many plug-in modules, each implementing a particular model for a
  facilty, institution or region, and known as \textit{archetypes}, and
\item an open source analysis and visualization tool, known as Cyclist.
\end{itemize}

The first section of this chapter will describe the fundamental design and
implementation of the \Cyclus kernel while the following section will describe
the infrastructure to support the development of new archetypes.

\section{Fundamental Design and Implementation} %%fundamentals paper

More details regarding the implementation and demonstration of the fundamental
design of the \Cyclus kernel are available in ref
\citeprod{huff-fundamentals}/.

\subsection{Modularity}

The modular nature of \Cyclus is a key element to its ability to remain
flexible, and also drives many subsequent design decisions.  The main goal of
this flexibility is to allow for the computational models that represent
individual agents (see Section \ref{sec:agents}) to be swapped easily, as a
user option.  Two specific advantages of this choice are that (a) individual
researchers can focus their efforts on new modules that match their expertise
and support their needs, and (b) the impact of changing modeling choices can
be explored in a consistent environment by swapping only one module at a time.

In its purest expression, each module operates in a so-called
\textit{black-box} fashion.  That is, any single module has no knowledge of
the internal state or behavior of any other module and can only interact in a
narrowly defined and specific way.  In addition to imposing a number of
software engineering limitations on the implementation of the kernel and
archetypes, this design goal also requires careful design of that interaction
interface among the modules.

Figure \ref{fig:framework} illustrates this concept, indicating the different
\gls{API} for each type of agent, and the possibility of different
implementations in each case.  Different implementations of each type of
facility, for example, may use different models to describe the physics and/or
the interaction behavior of that facility.  These differences can represent
small perturbations from other implementations or entirely different
approaches, including wrapping other software.  Because the modules can be
swapped at runtime, without requiring the software to be recompiled, this also
facilitates different distribution modes for these modules, as shown in Figure
\ref{fig:modifiedopen}, including fully open source, export controlled, and/or
proprietary commercially licensed modules.

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=0.7\columnwidth]{./images/framework}
\caption{The \Cyclus core provides \glspl{API} that abstract away the details in
the kernel and allow the archetypes to be loaded into the simulation in a modular
fashion.\cite{huff-fundamentals}}
\end{center}
\label{fig:framework}
\end{figure}

\begin{figure}[htbp]
\begin{center}
\includegraphics[width=0.5\columnwidth]{./images/modifiedopen.eps}
\caption{The \Cyclus framework enables fully open, partially open, and fully
closed collaborations\cite{carlsen_cyclus_2014}.}
\end{center}
\label{fig:modifiedopen}
\end{figure}


\subsection{Agent-based Paradigm}
\label{sec:abm}
% superior detail in capturing simulation dynamics
% more flexible control over behavior
% describe Region/Institution/Facility hierarchy
% note importance of generic resource exchange paradigm

\Cyclus implements an \acrlong{ABM} paradigm.  In addition to being a natural
consquence of the modularity described above, the \gls{ABM} paradigm is more
flexible and intuitive (from both a developer and user perspective) than the
system dynamic approach used in current simulators.  System dynamics is a
popular approach for modeling nuclear fuel cycles
\cite{jacobson_vision_2009,van_den_durpel_daness_2009,guerin_impact_2009,guerin_benchmark_2009}.
Formally however, system dynamics models are simply a strict subset of
agent-based models \cite{macal_agent-based_2010}.  That is, any system
dynamics model can be translated into an agent-based model.  \gls{ABM}
techniques therefore enable a broader range of simulations in a more generic
fashion.

To ensure interchageability, all agents are based on a common set of
object-oriented \glspl{API} defined as part of the \Cyclus kernel that define
how they interact with other agents and with the environment.  These
\glspl{API} standardize and simplify the implementation of required agent
behavior such as trading resources.  Optional \textit{mixins} are also
provided in a toolkit to provide community standards for some optional
behaviors.  More details on archetype development are in section
\ref{sec:archetypes}.

\Cyclus provides a novel representation of entities in the nuclear fuel cycle
that reflects the reality in international nuclear power: \textit{facilities}
implementing individual fuel cycle technologies, \textit{institutions}
managing those facilities, and \textit{regions} providing geographical and
political context for institutions and facilities.  Under this paradigm,
regions and institutions are first class agents much like facilities: they can
be developed as stand-alone modules to implement different behaviors and
swapped at runtime.  \Cyclus implements a \gls{RIF} relationship through a
parent-child hierarchy where regions are the parents of institutions which
are, in turn, the parents of facilities.  In this structure, institutions are
typically responsible for making decisions to deploy and decommissioning
faciltiies, while regions are typically responsible for establishing an energy
demand.  Both regions and institutions can have an impact on inter-facility
resource flow during the resource exchange process.

\subsection{Discrete Objects}
% enables more realistic models and metrics
% material routing metrics
% shadow fuel cycles
% etc.

Implied by this \gls{ABM} paradigm is that \Cyclus models facilities,
institutions, regions, and resources as discrete objects, allowing for a range
of modeling granularity.  This is in contrast the the fleet-based approach
used in most other fuel cycle simulators, although it is possible to implement
\Cyclus archetypes that represent fleets of identically behaving facilities.
This discrete facility capability is necessary to enable the tracking of
discrete material objects.  Examples of use cases supported by discrete
material tracking include spent fuel storage, transport and disposal models
that require representation of discrete casks and the individual isotopic
compositions of their contents.

Another such use case seeks to capture system vulnerability to material
diversion. Provenance and trade-history of distinct materials is the
fundamental information unit in such studies, and so this type of analysis
requires discrete simulation of a target facility and the individual materials
modified within it.  Material risk analysis, therefore, demands that both
facilities and materials should be discretely modeled objects like those in
\Cyclus.

\Cyclus represents these discrete tradable objects generically as
\textit{resources}, with a specific implementation for \textit{materials} to
represent typical nuclear materials with a mass and nuclide composition.
Typical operations on material objects, e.g. splitting, combining, decay, etc,
are tracked in detail to support simulation wide conservation.  The history of
ownership and transfer of each object is also tracked.

Material objects in \Cyclus can have compositions with an arbitrary number of
nuclides and can be optionally subject to radioactive decay, either at the
discretion of the facilities which own/manage the material, or whenever it is
observed/traded in the simulation.  In large simulations, this tracking of
discrete material objects can lead to many objects that change frequently.  A
number of implementation details exist to minimize the impact on system memory
and output database file size.

A critical capability at the intersection of the swappable archetype and the
discrete resource object paradigms is the \gls{DRE} which implements a market
mechanism at each time step for matching consumer agents' requests for
material with supplier agents' offers for material.  The \gls{DRE} is
described in detail in Ref \cite{gidden_agent-based_2015}.  Supporting the
general \Cyclus philosophy, facilities are treated as black boxes and a
supply-demand communication framework is defined.  The primary development of
the \gls{DRE} was supported under a different project and is reported
there\cite{cyclus-opt-report}.

The \gls{DRE} is a novel simulation concept in the nuclear fuel cycle domain. It
provides a flexible supply-demand infrastructure, supporting dynamic flows of
resources between agents, even as those agents enter and leave the simulation, and
even when those agents are defined by archetypes of arbitrary complexity. Trading
between agents can be affected by both the
proposed quality of a resource and agent relationships through the use of
preferences. Accordingly, a wide range of possible effects can be
modeled, from capacity-limited fuel supply to international trade agreements.

\subsection{Simulation Support}
So that users and developers can build working simulations in the shortest time
possible, the \Cyclus ecosystem provides fundamental building blocks: basic
archetypes and a toolkit of commonly needed functions.  The \Cycamore library
provides a suite of fundamental Region, Institution, and Facility archetypes,
while the \Cyclus toolkit provides assistance to developers.

\Cycamore \cite{carlsen_cycamore_2014}, the \Cyclus additional module
repository, provides a fundamental set of dynamically loadable libraries
providing agent archetypes for basic simulation
functionality within \Cyclus.  Since \Cyclus relies on external
archetypes to represent the agents within a simulation, \Cycamore provides the
basic archetypes a new user needs to get started running simple simulations.
These archetypes support a minimal set of fuel cycle simulation goals and
provide, by example, a guide to new developers who would seek to contribute
their own archetypes outside of \Cycamore.

As of version 1.5, \Cycamore contains one region archetype, two institution
archetypes, and eight facility archetypes. Short descriptions of these functions can be found in
Table \ref{tab:cycamore}.

\begin{table*}[htb]
\centering
\begin{tabularx}{\textwidth}{rlX}
\hline
\textbf{Entity} & \textbf{Archetype} & \textbf{Functionality} \\
\hline
Facility & EnrichmentFacility & This facility enriches uranium at a specified capacity. \\
Facility & FuelFab & This facility fabricates fuel material based on separated streams. \\
Facility & Reactor & A reactor model that handles batch refueling, based on pre-determined recipes of compositions. It requests any number of input fuel types and transmutes them to static compositions upon discharge.\\
Facility & Separations & This facility separates an incoming material into specified streams. \\
Facility & Storage & This facility holds incoming material for a specified time until before it is offered. \\
Facility & Mixer & This facility combined a set of incoming streams into a single stream. \\
Facility & Sink & This facility is capable of accepting a finite or infinite quantity of some commodity produced in the simulation. \\
Facility & Source & This facility generates material of the composition and commodity type specified as input.  \\
Institution & ManagerInst & The manager institution manages production of commodities among its facilities by building new ones as needed. \\
Institution & DeployInst &  This institution deploys specific facilities as defined explicitly in the input file. \\
Region & GrowthRegion & This region determines whether there is a need to meet a certain capacity (as defined via input) at each time step. \\
\hline
\end{tabularx}
\caption{The Archetypes in \Cycamore seek to cover a large range of simple
simulation use cases \cite{carlsen_cycamore_2014}.}
\label{tab:cycamore}
\end{table*}

In addition to the core functionality of the \Cyclus kernel, which is focused
on the set of capabilities needed to implement an agent-based simulation with
\gls{DRE}, a toolkit is provided to assist developers and users with robust
and standardized implementations of related simulation and nuclear engineering
tasks. The toolkit is an actively developed part of \Cyclus, with a primarily
forward-looking focus on supporting interesting \textit{in situ} metric
analysis tools.  The toolkit contains methods to support demand-constrined
facility agent deployment with methods that describe different shaped curves
for electricty demand, and then assess the available capacity relative to
those demand curves, deploying new facilities when necessary.  The toolkit
also includes nuclear engineering specific methods, such as models to
calculate the relationship between material quantity, quality and enrichment
capacity.

\subsection{Quality Assurance}

To garner the trust of a broad user and archetype developer community, the
\Cyclus project must implement a strategy to assure the ongoing quality of the
software it provides.  Multiple strategies, collectively known as
\emph{\gls{QA}}, have been developed by the scientific software development
community to mitigate structural and algorithmic errors in software.  \Cyclus
has adopted the best practices of the open source software community for
ensuring software quality including:
\begin{itemize}
\item version control: careful control and cataloging of changes to the
  software with full attribution of each change to each author,
\item code review: every individual change is reviewed by another developer
  for many aspects, from style to algorithmic performance to correctness, and
\item continuous integration: automated testing of indivdual software units
  and integrated solutions as each change is proposed and incorporated.
\end{itemize}


\section{Facilitating Archetype Developers} %% Archetype paper

